<Target Name="_AssignProjectProperties">
  <ItemGroup>
    <Project>
      <Properties Condition="$(_ProjectBuildTarget) == 'Build'">OutDir=$(OutDir)\%(TargetDir)\;IntDir=$(IntDir)\%(Name)\;TargetName=%(TargetName);TargetExt=%(TargetExt)</Properties>
      <Properties Condition="$(_ProjectBuildTarget) == 'BuildSdist'">OutDir=$(OutDir);IntDir=$(IntDir)\%(Name)\;TargetName=%(TargetName);TargetExt=%(TargetExt)</Properties>
    </Project>
  </ItemGroup>
</Target>

<Target Name="_AssignContentProperties">
  <ItemGroup>
    <Content>
      <_CopyDestination Condition="$(_ProjectBuildTarget) == 'Build'">$(OutDir)%(TargetDir)\%(TargetName)%(TargetExt)</_CopyDestination>
      <_CopyDestination Condition="$(_ProjectBuildTarget) == 'BuildSdist'">$(OutDir)%(RelativeSource)</_CopyDestination>
    </Content>
  </ItemGroup>
</Target>

<Target Name="_EnsureContentDirectories">
  <ItemGroup>
    <_Outputs Include="%(Content._CopyDestination)" />
  </ItemGroup>
  <Message Text="Creating directory: %(_Outputs.RootDir)%(_Outputs.Directory)" />
  <MakeDir Directories="%(_Outputs.RootDir)%(_Outputs.Directory)" />
</Target>

<Target Name="BuildDependencies" DependsOnTargets="_AssignProjectProperties">
  <MSBuild Projects="@(Project)" Targets="$(_ProjectBuildTarget)" Properties="%(Project.Properties)" />
</Target>

<Target Name="BuildContent" DependsOnTargets="_AssignContentProperties;_EnsureContentDirectories">
  <Copy SourceFiles="%(Content.FullPath)" DestinationFiles="%(Content._CopyDestination)" />
</Target>

<Target Name="CleanDependencies" DependsOnTargets="_AssignProjectProperties">
  <MSBuild Projects="@(Project)" Targets="Clean" Properties="%(Project.Properties)" />
</Target>

<Target Name="Build" DependsOnTargets="BuildDependencies;BuildContent">
</Target>

<Target Name="Clean" DependsOnTargets="CleanDependencies">
</Target>

<Target Name="Rebuild" DependsOnTargets="Clean;Build" />

<Target Name="BuildSdist" DependsOnTargets="BuildDependencies;_AssignContentProperties">
  <Copy SourceFiles="%(Content.FullPath)" DestinationFiles="%(Content._CopyDestination)" />
</Target>
