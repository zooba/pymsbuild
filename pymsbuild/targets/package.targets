<Project>
  <Target Name="_AssignContentProperties">
    <ItemGroup>
      <Content>
        <TargetDir Condition="%(TargetDir) == ''">$([msbuild]::EnsureTrailingSlash($([System.IO.Path]::GetDirectoryName(%(Name)))))</TargetDir>
        <TargetName Condition="%(TargetName) == ''">$([System.IO.Path]::GetFileNameWithoutExtension(%(Name)))</TargetName>
        <TargetExt Condition="%(TargetExt) == ''">$([System.IO.Path]::GetExtension(%(Name)))</TargetExt>
      </Content>
      <Content>
        <RelativeSource Condition="%(RelativeSource) == ''">$([msbuild]::MakeRelative($(SourceDir.TrimEnd(`\`)), %(FullPath)))</RelativeSource>
        <Destination Condition="%(IncludeInWheel)">$(OutDir)%(TargetDir)%(TargetName)%(TargetExt)</Destination>
        <Source>$(OutDir)%(RelativeSource)</Source>
      </Content>
    </ItemGroup>
  </Target>

  <Target Name="_MkdirContent">
    <ItemGroup>
      <_Outputs Include="%(Content.Destination)" />
    </ItemGroup>
    <MakeDir Directories="%(_Outputs.RootDir)%(_Outputs.Directory)" />
  </Target>

  <Target Name="_CopyContent" Inputs="@(Content)" Outputs="%(Content.Destination)">
    <Copy SourceFiles="%(Content.FullPath)" DestinationFiles="%(Content.Destination)" Condition="%(Content.Destination) != ''" />
    <ItemGroup>
      <FileWrites Include="%(Content.Destination)" />
    </ItemGroup>
  </Target>

  <Target Name="Build" DependsOnTargets="_AssignContentProperties;BuildDependencies;_CopyContent" />

  <Target Name="CalculateInPlace">
    <ItemGroup>
      <InPlace Include="@(Content)">
        <Destination>%(SourceDir)\%(TargetDir)%(TargetName)%(TargetExt)</Destination>
      </InPlace>
    </ItemGroup>
  </Target>

  <Target Name="_InPlace_Exclude" AfterTargets="CalculateInPlace">
    <ItemGroup>
      <_ToRemove Include="@(InPlace)" Condition="%(Extension) == '.exp'" />
      <InPlace Remove="@(_ToRemove)" />
    </ItemGroup>
  </Target> 

  <Target Name="_MkdirInPlace">
    <ItemGroup>
      <_Outputs Include="%(InPlace.Destination)" />
    </ItemGroup>
    <MakeDir Directories="%(_Outputs.RootDir)%(_Outputs.Directory)" />
  </Target>

  <Target Name="_CopyInPlace" Inputs="@(InPlace)" Outputs="%(InPlace.Destination)">
    <ItemGroup>
      <FileWrites Include="%(InPlace.Destination)" Condition="!Exists(%(InPlace.Destination))" />
    </ItemGroup>
    <Copy SourceFiles="%(InPlace.FullPath)" DestinationFiles="%(InPlace.Destination)" />
  </Target>

  <Target Name="BuildInPlace" DependsOnTargets="Build;CalculateInPlace;_MkdirInPlace;_CopyInPlace">
    <Message Text="Copied to source tree:" Importance="high" Condition="@(InPlace) != ''" />
    <Message Text=" - %(InPlace.Destination)" Importance="high" Condition="@(InPlace) != ''" />
  </Target>

  <Target Name="Clean" />

  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />
  <Target Name="RebuildInPlace" DependsOnTargets="Clean;BuildInPlace" />
  <Target Name="RebuildSdist" DependsOnTargets="Clean;BuildSdist" />
</Project>
